---
title: "The Score is still Q to 12"
subtitle: "Analyzing the Most Chaotic Sport in the Universe"
date: today
format:
  html:
    code-fold: false
    code-tools: false
    toc: true
    toc-depth: 3
    theme: cosmo
    df-print: paged
    css: styles.css
execute:
  warning: false
  message: false
  echo: false
---

```{r setup}
#| include: false
library(tidyverse)
library(gt)
library(scales)

# Comic book color palette
comic_colors <- c("#FF6B6B", "#4ECDC4", "#FFD93D", "#6C5CE7", 
                  "#A8E6CF", "#FF8B94", "#95E1D3", "#F38181")

# Create custom comic book theme for ggplot2
theme_comic <- function(base_size = 14) {
  theme_minimal(base_size = base_size) +
    theme(
      # Text elements
      text = element_text(family = "sans", color = "#2C3E50"),
      plot.title = element_text(
        face = "bold", 
        size = rel(1.6),
        hjust = 0.5,
        color = "#E74C3C",
        margin = margin(b = 10)
      ),
      plot.subtitle = element_text(
        size = rel(1.1),
        hjust = 0.5,
        color = "#34495E",
        face = "italic",
        margin = margin(b = 15)
      ),
      
      # Axis elements
      axis.title = element_text(face = "bold", size = rel(1.1), color = "#2C3E50"),
      axis.text = element_text(color = "#2C3E50", size = rel(0.9)),
      axis.line = element_line(color = "#000", size = 1.5),
      axis.ticks = element_line(color = "#000", size = 1),
      
      # Panel elements
      panel.background = element_rect(fill = "white", color = "#000", size = 2),
      panel.border = element_rect(fill = NA, color = "#000", size = 3),
      panel.grid.major = element_line(color = "#E0E0E0", size = 0.5, linetype = "dashed"),
      panel.grid.minor = element_blank(),
      
      # Legend
      legend.background = element_rect(fill = "#FFF9E6", color = "#000", size = 2),
      legend.title = element_text(face = "bold", size = rel(1)),
      legend.text = element_text(size = rel(0.9)),
      legend.key = element_rect(fill = "white", color = "#000"),
      
      # Plot background
      plot.background = element_rect(fill = "#FFF9E6", color = NA),
      plot.margin = margin(20, 20, 20, 20)
    )
}

# Set as default theme
theme_set(theme_comic())

# Set default color scales
scale_colour_discrete <- function(...) {
  scale_colour_manual(..., values = comic_colors)
}
scale_fill_discrete <- function(...) {
  scale_fill_manual(..., values = comic_colors)
}

# Custom comic book gt theme
gt_theme_comic <- function(data, ...) {
  data %>%
    tab_options(
      # Table styling
      table.background.color = "white",
      table.border.top.style = "solid",
      table.border.top.width = px(4),
      table.border.top.color = "#000",
      table.border.bottom.style = "solid",
      table.border.bottom.width = px(4),
      table.border.bottom.color = "#000",
      
      # Header styling
      heading.background.color = "#FFD93D",
      heading.border.bottom.style = "solid",
      heading.border.bottom.width = px(4),
      heading.border.bottom.color = "#000",
      heading.align = "center",
      
      # Column labels
      column_labels.background.color = "#FF6B6B",
      column_labels.font.weight = "bold",
      column_labels.font.size = px(16),
      column_labels.border.top.style = "solid",
      column_labels.border.top.width = px(3),
      column_labels.border.top.color = "#000",
      column_labels.border.bottom.style = "solid",
      column_labels.border.bottom.width = px(3),
      column_labels.border.bottom.color = "#000",
      
      # Data cells
      data_row.padding = px(10),
      table.font.size = px(14),
      
      # Borders between rows
      table_body.border.bottom.style = "solid",
      table_body.border.bottom.width = px(2),
      table_body.border.bottom.color = "#000",
      
      # Striped rows
      row.striping.include_table_body = TRUE,
      row.striping.background_color = "#FFF9E6"
    ) %>%
    tab_style(
      style = cell_text(
        weight = "bold",
        color = "#2C3E50"
      ),
      locations = cells_column_labels()
    ) %>%
    tab_style(
      style = cell_text(
        color = "#2C3E50"
      ),
      locations = cells_body()
    ) %>%
    opt_table_font(
      font = list(
        google_font("Comic Neue"),
        default_fonts()
      )
    )
}
```

## Introduction {.comic-panel}

> "The only permanent rule is that you can't play it the same way twice!" - Calvin

Welcome to the first comprehensive analysis of the **Calvinball League**, where chaos meets competition and rules are made up on the spot! 

**‚ö° KAPOW! ‚ö°** Get ready for an exploratory data analysis that examines:

- üé≠ Player performance metrics (including the all-important *style points*!)
- üèÜ Team dynamics and competitive balance  
- üé≤ The beautifully unpredictable nature of the game
- üìä Statistical patterns in pure chaos

*Warning: Traditional sports analytics may not apply here!*

## Data Loading

```{r load-data}
# Load all datasets
players <- read_csv("data/players.csv", show_col_types = FALSE)
teams <- read_csv("data/teams.csv", show_col_types = FALSE)
games <- read_csv("data/games.csv", show_col_types = FALSE)
player_stats <- read_csv("data/player_stats.csv", show_col_types = FALSE)
player_summary <- read_csv("data/players_summary.csv", show_col_types = FALSE)
team_records <- read_csv("data/team_records.csv", show_col_types = FALSE)

# Create overview summary
overview_text <- sprintf(
"üìä **Dataset Overview**

‚Ä¢ %d players across %d teams
‚Ä¢ %d games played over %d seasons  
‚Ä¢ %d individual performance records

*The Calvinball League data is ready for analysis!*",
  nrow(players), 
  nrow(teams),
  nrow(games), 
  length(unique(games$season)),
  nrow(player_stats)
)

cat(overview_text)
```

## League Structure

### Teams

```{r teams-overview}
teams_with_size <- players %>%
  count(team_id, name = "roster_size") %>%
  left_join(teams, by = "team_id")

teams_with_size %>% 
  select(team_name, roster_size) %>%
  gt() %>%
  cols_label(
    team_name = "Team Name",
    roster_size = "Roster Size"
  ) %>%
  tab_header(
    title = "‚ö° Calvinball League Team Roster Sizes ‚ö°"
  ) %>%
  gt_theme_comic()
```

### Player Distribution

```{r player-distribution}
#| fig-height: 4
#| fig-cap: "Players are relatively evenly distributed across teams"

players %>%
  left_join(teams, by = "team_id") %>%
  count(team_name) %>%
  ggplot(aes(x = reorder(team_name, n), y = n, fill = team_name)) +
  geom_col(show.legend = FALSE) +
  geom_text(aes(label = n), hjust = -0.3) +
  coord_flip() +
  labs(title = "Team Roster Sizes",
       x = NULL,
       y = "Number of Players") +
  scale_fill_brewer(palette = "Set2") +
  ylim(0, max(table(players$team_id)) + 1)
```

## Game Analysis

### Scoring Chaos

One of the hallmarks of Calvinball is its completely unpredictable scoring system!

```{r score-distribution}
#| fig-height: 5
#| fig-cap: "Calvinball scores show extreme variability, from negative to thousands"

games_long <- games %>%
  select(game_id, season, score_home, score_away) %>%
  pivot_longer(cols = c(score_home, score_away),
               names_to = "location",
               values_to = "score")

ggplot(games_long, aes(x = score)) +
  geom_histogram(bins = 50, fill = "steelblue", alpha = 0.7) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "red") +
  labs(title = "Distribution of Game Scores",
       subtitle = "Note the negative scores and extreme outliers - pure Calvinball!",
       x = "Score",
       y = "Frequency") +
  scale_x_continuous(labels = comma)
```

```{r score-summary}
score_stats <- games_long %>%
  summarise(
    min_score = min(score),
    median_score = median(score),
    mean_score = mean(score),
    max_score = max(score),
    sd_score = sd(score)
  )

score_stats %>%
  gt() %>%
  cols_label(
    min_score = "Minimum",
    median_score = "Median",
    mean_score = "Mean",
    max_score = "Maximum",
    sd_score = "Std Dev"
  ) %>%
  fmt_number(
    columns = everything(),
    decimals = 1
  ) %>%
  tab_header(
    title = "üìä Summary Statistics for Game Scores üìä"
  ) %>%
  gt_theme_comic()
```

### Scoring Types

In true Calvinball fashion, the scoring system changes from game to game!

```{r scoring-types}
#| fig-height: 5
#| fig-cap: "The variety of scoring systems used throughout the league"

games %>%
  count(scoring_type) %>%
  ggplot(aes(x = reorder(scoring_type, n), y = n, fill = scoring_type)) +
  geom_col(show.legend = FALSE) +
  geom_text(aes(label = n), hjust = -0.3, size = 3) +
  coord_flip() +
  labs(title = "Frequency of Scoring Types",
       subtitle = "Because consistency is boring!",
       x = NULL,
       y = "Number of Games") +
  scale_fill_brewer(palette = "Set3") +
  ylim(0, max(table(games$scoring_type)) + 3)
```

### Score Differentials

```{r score-differential}
#| fig-height: 4
#| fig-cap: "Game competitiveness varies wildly"

games %>%
  mutate(differential = abs(score_home - score_away)) %>%
  ggplot(aes(x = differential)) +
  geom_histogram(bins = 40, fill = "coral", alpha = 0.7) +
  labs(title = "Score Differentials",
       subtitle = "How close are Calvinball games?",
       x = "Absolute Score Differential",
       y = "Number of Games") +
  scale_x_continuous(labels = comma)
```

## Team Performance

### Win-Loss Records

```{r team-records}
#| fig-height: 6
#| fig-cap: "Team performance across all three seasons"

team_records_plot <- team_records %>%
  group_by(team_name) %>%
  mutate(total_wins = sum(wins)) %>%
  ungroup() %>%
  mutate(season = factor(season))

ggplot(team_records_plot, aes(x = reorder(team_name, total_wins), y = wins, fill = season)) +
  geom_col(position = "dodge") +
  coord_flip() +
  labs(title = "Team Wins by Season",
       x = NULL,
       y = "Wins",
       fill = "Season") +
  scale_fill_brewer(palette = "Set1")
```

```{r overall-records}
overall_records <- team_records %>%
  group_by(team_id, team_name) %>%
  summarise(
    total_wins = sum(wins),
    total_losses = sum(losses),
    total_ties = sum(ties),
    .groups = "drop"
  ) %>%
  mutate(
    total_games = total_wins + total_losses + total_ties,
    win_pct = total_wins / total_games
  ) %>%
  arrange(desc(win_pct))

overall_records %>% 
  select(team_name, total_wins, total_losses, total_ties, win_pct) %>%
  gt() %>%
  cols_label(
    team_name = "Team",
    total_wins = "Wins",
    total_losses = "Losses",
    total_ties = "Ties",
    win_pct = "Win %"
  ) %>%
  fmt_number(
    columns = win_pct,
    decimals = 3
  ) %>%
  tab_header(
    title = "üèÜ Overall Team Records (All Seasons) üèÜ"
  ) %>%
  gt_theme_comic()
```

### Home vs Away Performance

```{r home-away}
#| fig-height: 5
#| fig-cap: "Does home field advantage exist in Calvinball?"

games %>%
  mutate(
    home_win = score_home > score_away,
    away_win = score_away > score_home,
    tie = score_home == score_away
  ) %>%
  summarise(
    `Home Wins` = sum(home_win),
    `Away Wins` = sum(away_win),
    `Ties` = sum(tie)
  ) %>%
  pivot_longer(everything(), names_to = "outcome", values_to = "count") %>%
  ggplot(aes(x = outcome, y = count, fill = outcome)) +
  geom_col(show.legend = FALSE) +
  geom_text(aes(label = count), vjust = -0.5, size = 5) +
  labs(title = "Home vs Away Performance",
       subtitle = "Surprisingly, there might be a home field advantage!",
       x = NULL,
       y = "Number of Games") +
  scale_fill_manual(values = c("Home Wins" = "forestgreen", 
                                "Away Wins" = "firebrick", 
                                "Ties" = "gray60")) +
  ylim(0, max(c(sum(games$score_home > games$score_away),
                sum(games$score_away > games$score_home))) + 10)
```

## Player Performance

### Style Points Leaders

In Calvinball, style matters as much as substance!

```{r style-leaders}
top_style <- player_summary %>%
  arrange(desc(avg_style_points)) %>%
  head(10) %>%
  left_join(teams, by = "team_id")

top_style %>% 
  select(player_name, team_name, games_played, avg_style_points) %>%
  gt() %>%
  cols_label(
    player_name = "Player",
    team_name = "Team",
    games_played = "Games",
    avg_style_points = "Avg Style Points"
  ) %>%
  fmt_number(
    columns = avg_style_points,
    decimals = 2
  ) %>%
  tab_header(
    title = "‚≠ê Top 10 Players by Average Style Points ‚≠ê",
    subtitle = "Because flair matters in Calvinball!"
  ) %>%
  gt_theme_comic()
```

```{r style-plot}
#| fig-height: 6
#| fig-cap: "The most stylish Calvinball players"

top_style %>%
  ggplot(aes(x = reorder(player_name, avg_style_points), 
             y = avg_style_points,
             fill = team_name)) +
  geom_col() +
  coord_flip() +
  labs(title = "Top 10 Players by Average Style Points",
       subtitle = "Flair and panache are everything in Calvinball!",
       x = NULL,
       y = "Average Style Points",
       fill = "Team") +
  scale_fill_brewer(palette = "Set2")
```

### Wickets and Performance Metrics

```{r wickets-analysis}
#| fig-height: 5
#| fig-cap: "Relationship between different Calvinball metrics"

player_summary %>%
  ggplot(aes(x = avg_wickets, y = avg_style_points)) +
  geom_point(alpha = 0.6, size = 3, color = "darkblue") +
  geom_smooth(method = "lm", se = TRUE, color = "red", linetype = "dashed") +
  labs(title = "Style Points vs Wickets Scored",
       subtitle = "Is there a relationship between technical skill and style?",
       x = "Average Wickets Scored",
       y = "Average Style Points")
```

### Most Active Players

```{r active-players}
#| fig-height: 6

player_summary %>%
  arrange(desc(games_played)) %>%
  head(10) %>%
  left_join(teams, by = "team_id") %>%
  ggplot(aes(x = reorder(player_name, games_played), 
             y = games_played,
             fill = team_name)) +
  geom_col() +
  coord_flip() +
  labs(title = "Most Active Players",
       subtitle = "Games played across all seasons",
       x = NULL,
       y = "Games Played",
       fill = "Team") +
  scale_fill_brewer(palette = "Spectral")
```

### Rule Declarations

Spontaneous rule declarations are a cornerstone of Calvinball strategy!

```{r rule-declarations}
top_declarers <- player_summary %>%
  arrange(desc(total_rule_declarations)) %>%
  head(10) %>%
  left_join(teams, by = "team_id")

top_declarers %>%
  select(player_name, team_name, total_rule_declarations, games_played) %>%
  gt() %>%
  cols_label(
    player_name = "Player",
    team_name = "Team",
    total_rule_declarations = "Total Declarations",
    games_played = "Games Played"
  ) %>%
  fmt_number(
    columns = c(total_rule_declarations, games_played),
    decimals = 0
  ) %>%
  tab_header(
    title = "üé® Top Rule Declarers üé®",
    subtitle = "The most creative minds in Calvinball!"
  ) %>%
  gt_theme_comic()
```

## Advanced Metrics

### Player Versatility Score

Let's create a versatility metric combining multiple stats:

```{r versatility}
#| fig-height: 7

player_versatility <- player_summary %>%
  left_join(teams, by = "team_id") %>%
  mutate(
    # Normalize each metric to 0-1 scale
    style_norm = (avg_style_points - min(avg_style_points)) / 
                 (max(avg_style_points) - min(avg_style_points)),
    wickets_norm = (avg_wickets - min(avg_wickets)) / 
                   (max(avg_wickets) - min(avg_wickets)),
    declarations_norm = (total_rule_declarations - min(total_rule_declarations)) / 
                        (max(total_rule_declarations) - min(total_rule_declarations)),
    # Versatility score
    versatility = (style_norm + wickets_norm + declarations_norm) / 3
  ) %>%
  arrange(desc(versatility)) %>%
  head(15)

player_versatility %>%
  ggplot(aes(x = reorder(player_name, versatility), 
             y = versatility,
             fill = team_name)) +
  geom_col() +
  coord_flip() +
  labs(title = "Top 15 Most Versatile Players",
       subtitle = "Combining style, wickets, and rule declarations",
       x = NULL,
       y = "Versatility Score",
       fill = "Team") +
  scale_fill_brewer(palette = "Set3")
```

### Temporal Trends

```{r temporal}
#| fig-height: 5
#| fig-cap: "How have scores evolved over time?"

games %>%
  mutate(avg_total_score = (score_home + score_away) / 2) %>%
  ggplot(aes(x = date, y = avg_total_score)) +
  geom_point(alpha = 0.4, color = "steelblue") +
  geom_smooth(method = "loess", color = "darkred", se = TRUE) +
  labs(title = "Average Total Scores Over Time",
       subtitle = "Is Calvinball getting more or less chaotic?",
       x = "Date",
       y = "Average Total Score") +
  scale_y_continuous(labels = comma)
```

```{r season-comparison}
games %>%
  group_by(season) %>%
  summarise(
    games_played = n(),
    avg_home_score = mean(score_home),
    avg_away_score = mean(score_away),
    avg_total = mean(score_home + score_away),
    pct_ties = mean(score_home == score_away) * 100,
    .groups = "drop"
  ) %>%
  gt() %>%
  cols_label(
    season = "Season",
    games_played = "Games",
    avg_home_score = "Avg Home",
    avg_away_score = "Avg Away",
    avg_total = "Avg Total",
    pct_ties = "Tie %"
  ) %>%
  fmt_number(
    columns = c(avg_home_score, avg_away_score, avg_total, pct_ties),
    decimals = 1
  ) %>%
  tab_header(
    title = "üìÖ Season-by-Season Comparison üìÖ",
    subtitle = "How has the league evolved?"
  ) %>%
  gt_theme_comic()
```

## Individual Game Statistics

### Distribution of Key Metrics

```{r metric-distributions}
#| fig-height: 8
#| fig-cap: "Distribution of various Calvinball performance metrics"

player_stats %>%
  select(wickets_scored, opposite_touchdowns, mask_points, 
         flag_captures, style_points) %>%
  pivot_longer(everything(), names_to = "metric", values_to = "value") %>%
  ggplot(aes(x = value, fill = metric)) +
  geom_histogram(bins = 30, show.legend = FALSE) +
  facet_wrap(~metric, scales = "free", ncol = 2) +
  labs(title = "Distribution of Calvinball Performance Metrics",
       subtitle = "Each metric tells a different story",
       x = "Value",
       y = "Frequency") +
  scale_fill_brewer(palette = "Set1") +
  theme(strip.text = element_text(face = "bold"))
```

### Correlation Analysis

```{r correlations}
#| fig-height: 7
#| fig-cap: "Correlations between different Calvinball metrics"

# Calculate correlations
cor_data <- player_stats %>%
  select(wickets_scored, opposite_touchdowns, time_reversal_bonus,
         mask_points, flag_captures, invisible_zones_crossed,
         spontaneous_rule_declarations, song_quality_score, 
         style_points, fouls_committed) %>%
  cor(use = "complete.obs")

# Convert to long format for ggplot
cor_long <- cor_data %>%
  as.data.frame() %>%
  rownames_to_column("var1") %>%
  pivot_longer(-var1, names_to = "var2", values_to = "correlation")

# Plot using ggplot2
ggplot(cor_long, aes(x = var1, y = var2, fill = correlation)) +
  geom_tile(color = "white") +
  geom_text(aes(label = sprintf("%.2f", correlation)), size = 2.5) +
  scale_fill_gradient2(low = "blue", mid = "white", high = "red", 
                       midpoint = 0, limits = c(-1, 1)) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title = element_blank(),
        panel.grid = element_blank()) +
  labs(title = "Correlation Matrix of Calvinball Metrics",
       fill = "Correlation") +
  coord_fixed()
```

## Conclusions

::: {.callout}
::: {.callout-title}
üí• BAM! Key Findings üí•
:::

**1. SCORING CHAOS!** Calvinball lives up to its reputation with scores ranging from `r min(games_long$score)` to `r comma(max(games_long$score))`, with a standard deviation of `r comma(round(sd(games_long$score), 1))`. That's WILD!

**2. HOME FIELD ADVANTAGE?!** Despite the chaotic nature of the game, there appears to be a slight home field advantage, with home teams winning approximately `r round(100 * mean(games$score_home > games$score_away), 1)`% of games. Who knew?

**3. STYLE MATTERS!** ‚≠ê The top performers in style points show considerable variability, suggesting that multiple approaches to Calvinball can be successful. Flair is everything!

**4. COMPETITIVE BALANCE!** The league shows good parity, with win percentages ranging from `r round(min(overall_records$win_pct), 3)` to `r round(max(overall_records$win_pct), 3)`. Anyone can win!

**5. CREATIVE GENIUS!** üé® Players average `r round(mean(player_summary$total_rule_declarations, na.rm = TRUE), 1)` spontaneous rule declarations over their careers, demonstrating the inventive spirit of the game.
:::

### üöÄ Future Analysis Adventures

- ü§ù Investigate player chemistry and team combinations
- üîÆ Develop predictive models *(if that's even possible for Calvinball!)*
- üìà Analyze the impact of different scoring systems on outcomes
- üìä Study player development trajectories over time
- ‚öñÔ∏è Examine the relationship between fouls and creative rule-making
- üéØ Deep-dive into the physics of wickets and time reversals

---

<center>
*"Sometimes I think the surest sign that intelligent life exists elsewhere in the universe is that none of it has tried to contact us."*

üè¥ **The Score is STILL Q to 12!** üè¥
</center>
