---
title: "The Score is still Q to 12"
subtitle: "Analyzing the Most Chaotic Sport in the Universe"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{The Score is still Q to 12}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 7,
  fig.height = 5,
  warning = FALSE,
  message = FALSE
)
```

> "The only permanent rule is that you can't play it the same way twice!" - Calvin

Welcome to the first comprehensive analysis of the **Calvinball League**, where chaos meets competition and rules are made up on the spot!

Get ready for an exploratory data analysis that examines:
- Player performance metrics (including the all-important *style points*!)
- Team dynamics and competitive balance
- The beautifully unpredictable nature of the game
- Statistical patterns in pure chaos

*Warning: Traditional sports analytics may not apply here!*

## Loading the Data

The calvinball package provides six datasets that can be loaded directly:

```{r load-packages}
library(calvinball)
library(dplyr)
library(tidyr)
library(ggplot2)
```

```{r load-data}
# The datasets are loaded automatically with the package
# cb_players, cb_teams, cb_games, cb_player_stats, cb_player_summary, cb_team_records

# Quick overview
cat(sprintf("ðŸ“Š Dataset Overview

â€¢ %d players across %d teams
â€¢ %d games played over %d seasons
â€¢ %d individual performance records

The Calvinball League data is ready for analysis!",
  nrow(cb_players),
  nrow(cb_teams),
  nrow(cb_games),
  length(unique(cb_games$season)),
  nrow(cb_player_stats)
))
```

## League Structure

### Teams

```{r teams-overview}
teams_with_size <- cb_players |>
  count(team_id, name = "roster_size") |>
  left_join(cb_teams, by = "team_id")

teams_with_size |>
  select(team_name, roster_size) |>
  knitr::kable(col.names = c("Team Name", "Roster Size"))
```

### Player Distribution

```{r player-distribution, fig.height=4}
cb_players |>
  left_join(cb_teams, by = "team_id") |>
  count(team_name) |>
  ggplot(aes(x = reorder(team_name, n), y = n, fill = team_name)) +
  geom_col(show.legend = FALSE) +
  geom_text(aes(label = n), hjust = -0.3) +
  coord_flip() +
  labs(title = "Team Roster Sizes",
       x = NULL,
       y = "Number of Players") +
  scale_fill_brewer(palette = "Set2") +
  theme_minimal() +
  ylim(0, max(table(cb_players$team_id)) + 1)
```

## Game Analysis

### Scoring Chaos

One of the hallmarks of Calvinball is its completely unpredictable scoring system!

```{r score-distribution}
games_long <- cb_games |>
  select(game_id, season, score_home, score_away) |>
  pivot_longer(cols = c(score_home, score_away),
               names_to = "location",
               values_to = "score")

ggplot(games_long, aes(x = score)) +
  geom_histogram(bins = 50, fill = "steelblue", alpha = 0.7) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "red") +
  labs(title = "Distribution of Game Scores",
       subtitle = "Note the negative scores and extreme outliers - pure Calvinball!",
       x = "Score",
       y = "Frequency") +
  theme_minimal()
```

```{r score-summary}
score_stats <- games_long |>
  summarise(
    Minimum = min(score),
    Median = median(score),
    Mean = round(mean(score), 1),
    Maximum = max(score),
    `Std Dev` = round(sd(score), 1)
  )

knitr::kable(score_stats)
```

### Scoring Types

In true Calvinball fashion, the scoring system changes from game to game!

```{r scoring-types}
cb_games |>
  count(scoring_type) |>
  ggplot(aes(x = reorder(scoring_type, n), y = n, fill = scoring_type)) +
  geom_col(show.legend = FALSE) +
  geom_text(aes(label = n), hjust = -0.3, size = 3) +
  coord_flip() +
  labs(title = "Frequency of Scoring Types",
       subtitle = "Because consistency is boring!",
       x = NULL,
       y = "Number of Games") +
  scale_fill_brewer(palette = "Set3") +
  theme_minimal() +
  ylim(0, max(table(cb_games$scoring_type)) + 3)
```

## Team Performance

### Win-Loss Records

```{r team-records, fig.height=6}
team_records_plot <- cb_team_records |>
  group_by(team_name) |>
  mutate(total_wins = sum(wins)) |>
  ungroup() |>
  mutate(season = factor(season))

ggplot(team_records_plot, aes(x = reorder(team_name, total_wins), y = wins, fill = season)) +
  geom_col(position = "dodge") +
  coord_flip() +
  labs(title = "Team Wins by Season",
       x = NULL,
       y = "Wins",
       fill = "Season") +
  scale_fill_brewer(palette = "Set1") +
  theme_minimal()
```

```{r overall-records}
overall_records <- cb_team_records |>
  group_by(team_id, team_name) |>
  summarise(
    total_wins = sum(wins),
    total_losses = sum(losses),
    total_ties = sum(ties),
    .groups = "drop"
  ) |>
  mutate(
    total_games = total_wins + total_losses + total_ties,
    win_pct = round(total_wins / total_games, 3)
  ) |>
  arrange(desc(win_pct))

overall_records |>
  select(team_name, total_wins, total_losses, total_ties, win_pct) |>
  knitr::kable(col.names = c("Team", "Wins", "Losses", "Ties", "Win %"))
```

### Home vs Away Performance

```{r home-away}
home_away_summary <- cb_games |>
  summarise(
    `Home Wins` = sum(score_home > score_away),
    `Away Wins` = sum(score_away > score_home),
    `Ties` = sum(score_home == score_away)
  ) |>
  pivot_longer(everything(), names_to = "outcome", values_to = "count")

ggplot(home_away_summary, aes(x = outcome, y = count, fill = outcome)) +
  geom_col(show.legend = FALSE) +
  geom_text(aes(label = count), vjust = -0.5, size = 5) +
  labs(title = "Home vs Away Performance",
       subtitle = "Surprisingly, there might be a home field advantage!",
       x = NULL,
       y = "Number of Games") +
  scale_fill_manual(values = c("Home Wins" = "forestgreen",
                                "Away Wins" = "firebrick",
                                "Ties" = "gray60")) +
  theme_minimal() +
  ylim(0, max(home_away_summary$count) + 10)
```

## Player Performance

### Style Points Leaders

In Calvinball, style matters as much as substance!

```{r style-leaders}
top_style <- cb_player_summary |>
  arrange(desc(avg_style_points)) |>
  head(10) |>
  left_join(cb_teams, by = "team_id")

top_style |>
  select(player_name, team_name, games_played, avg_style_points) |>
  mutate(avg_style_points = round(avg_style_points, 2)) |>
  knitr::kable(col.names = c("Player", "Team", "Games", "Avg Style Points"))
```

```{r style-plot, fig.height=6}
top_style |>
  ggplot(aes(x = reorder(player_name, avg_style_points),
             y = avg_style_points,
             fill = team_name)) +
  geom_col() +
  coord_flip() +
  labs(title = "Top 10 Players by Average Style Points",
       subtitle = "Flair and panache are everything in Calvinball!",
       x = NULL,
       y = "Average Style Points",
       fill = "Team") +
  scale_fill_brewer(palette = "Set2") +
  theme_minimal()
```

### Wickets and Performance Metrics

```{r wickets-analysis}
cb_player_summary |>
  ggplot(aes(x = avg_wickets, y = avg_style_points)) +
  geom_point(alpha = 0.6, size = 3, color = "darkblue") +
  geom_smooth(method = "lm", se = TRUE, color = "red", linetype = "dashed") +
  labs(title = "Style Points vs Wickets Scored",
       subtitle = "Is there a relationship between technical skill and style?",
       x = "Average Wickets Scored",
       y = "Average Style Points") +
  theme_minimal()
```

### Rule Declarations

Spontaneous rule declarations are a cornerstone of Calvinball strategy!

```{r rule-declarations}
top_declarers <- cb_player_summary |>
  arrange(desc(total_rule_declarations)) |>
  head(10) |>
  left_join(cb_teams, by = "team_id")

top_declarers |>
  select(player_name, team_name, total_rule_declarations, games_played) |>
  knitr::kable(col.names = c("Player", "Team", "Total Declarations", "Games Played"))
```

## Advanced Metrics

### Player Versatility Score

Let's create a versatility metric combining multiple stats:

```{r versatility, fig.height=7}
player_versatility <- cb_player_summary |>
  left_join(cb_teams, by = "team_id") |>
  mutate(
    # Normalize each metric to 0-1 scale
    style_norm = (avg_style_points - min(avg_style_points)) /
                 (max(avg_style_points) - min(avg_style_points)),
    wickets_norm = (avg_wickets - min(avg_wickets)) /
                   (max(avg_wickets) - min(avg_wickets)),
    declarations_norm = (total_rule_declarations - min(total_rule_declarations)) /
                        (max(total_rule_declarations) - min(total_rule_declarations)),
    # Versatility score
    versatility = (style_norm + wickets_norm + declarations_norm) / 3
  ) |>
  arrange(desc(versatility)) |>
  head(15)

player_versatility |>
  ggplot(aes(x = reorder(player_name, versatility),
             y = versatility,
             fill = team_name)) +
  geom_col() +
  coord_flip() +
  labs(title = "Top 15 Most Versatile Players",
       subtitle = "Combining style, wickets, and rule declarations",
       x = NULL,
       y = "Versatility Score",
       fill = "Team") +
  scale_fill_brewer(palette = "Set3") +
  theme_minimal()
```

## Generating Fresh Data

If you want to generate your own Calvinball data with different parameters, use the `generate_calvinball_data()` function:
```{r generate-example, eval=FALSE}
# Generate a smaller league
small_league <- generate_calvinball_data(
  n_players = 12,
  n_teams = 3,
  n_games = 20,
  n_seasons = 1
)

# Access the datasets
small_league$players
small_league$games
```

## Conclusions

**Key Findings:**

1. **SCORING CHAOS!** Calvinball lives up to its reputation with scores ranging from `r min(games_long$score)` to `r format(max(games_long$score), big.mark = ",")`, with a standard deviation of `r format(round(sd(games_long$score), 1), big.mark = ",")`. That's WILD!

2. **HOME FIELD ADVANTAGE?!** Despite the chaotic nature of the game, there appears to be a slight home field advantage, with home teams winning approximately `r round(100 * mean(cb_games$score_home > cb_games$score_away), 1)`% of games. Who knew?
3. **STYLE MATTERS!** The top performers in style points show considerable variability, suggesting that multiple approaches to Calvinball can be successful.

4. **COMPETITIVE BALANCE!** The league shows good parity, with win percentages ranging from `r round(min(overall_records$win_pct), 3)` to `r round(max(overall_records$win_pct), 3)`. Anyone can win!

5. **CREATIVE GENIUS!** Players average `r round(mean(cb_player_summary$total_rule_declarations, na.rm = TRUE), 1)` spontaneous rule declarations over their careers, demonstrating the inventive spirit of the game.

---

**OLLY OLLY OXEN FREE!**

*"Sometimes I think the surest sign that intelligent life exists elsewhere in the universe is that none of it has tried to contact us and challenge us to Calvinball."*

**The Score is STILL Q to 12!**
